<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de administración - AVAR Joyas</title>
  <style>
    :root{--gold:#b6922e;--muted:#777;--card:#fff;--bg:#f6f6f6;--maxw:980px}
    *{box-sizing:border-box}
    body{font-family:Inter,Arial,system-ui,-apple-system;background:var(--bg);margin:0;padding:28px;color:#222;display:flex;justify-content:center}
    .container{width:100%;max-width:var(--maxw)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{margin:0;color:var(--gold);font-size:20px}
    .top-actions{display:flex;gap:10px;align-items:center}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(20,20,20,0.06)}
    form{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start}
    form .full{grid-column:1/3}
    label{font-size:13px;color:#333;display:block;margin-bottom:6px}
    input[type=text],input[type=number],select{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
    button.primary{background:var(--gold);color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
    button.ghost{background:#fff;border:1px solid #ddd;padding:8px 10px;border-radius:8px;cursor:pointer}
    .upload-row{display:flex;gap:10px;align-items:center}
    .upload-row input[type=file]{flex:1}
    #estadoUpload{margin:0;font-size:13px;color:var(--muted)}
    #previews,#editPreviews{display:flex;gap:8px;flex-wrap:wrap}
    .thumb{width:80px;height:80px;border-radius:8px;overflow:hidden;position:relative;border:1px solid #e6e6e6}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb button{position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer}
    .controls{display:flex;gap:10px;align-items:center;margin:16px 0}
    .controls input{padding:10px;border-radius:8px;border:1px solid #ddd}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .producto-card{padding:12px;border-radius:10px;background:var(--card);box-shadow:0 3px 12px rgba(10,10,10,0.04)}
    .producto-card h4{margin:0 0 6px 0}
    .producto-card small{display:block;color:var(--muted);word-break:break-all;font-size:12px}
    .producto-actions{display:flex;gap:8px;margin-top:10px}
    .pagination{display:flex;gap:6px;align-items:center;justify-content:center;margin-top:12px}
    .pagination button{padding:6px 10px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
    #modalEditar{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:1200}
    #modalEditar .modal-card{width:100%;max-width:560px}
    #loginOverlay{position:fixed;inset:0;background:linear-gradient(90deg, rgba(0,0,0,0.55), rgba(0,0,0,0.4));display:flex;align-items:center;justify-content:center;z-index:9999}
    #loginBox{width:100%;max-width:420px}
    .muted{color:var(--muted); font-size:13px}
    @media(max-width:720px){form{grid-template-columns:1fr}.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container" id="appContainer" aria-live="polite">
    <header>
      <h1>Panel de Administración — AVAR Joyas</h1>
      <div class="top-actions">
        <div id="usuarioBadge" class="muted"></div>
        <button id="logoutBtn" class="ghost" style="display:none">Cerrar sesión</button>
      </div>
    </header>

    <!-- AGREGAR PRODUCTO -->
    <section class="card" aria-label="Agregar producto">
      <form id="formProducto" autocomplete="off">
        <div>
          <label for="nombre">Nombre del producto</label>
          <input type="text" id="nombre" required />
        </div>

        <div>
          <label for="precio">Precio</label>
          <input type="number" id="precio" required min="0" />
        </div>

        <div>
          <label for="categoria">Categoría</label>
          <select id="categoria">
            <option value="">-- Selecciona --</option>
            <option value="collar">Collares</option>
            <option value="aretes">Aretes</option>
            <option value="tobilleras">Tobilleras</option>
            <option value="pulseras">Pulseras</option>
            <option value="anillos">Anillos</option>
          </select>
        </div>

        <div>
          <label for="stock">Stock</label>
          <input type="number" id="stock" required min="0" />
        </div>

        <div class="full">
          <label for="imagen">Ruta(s) de imagen (separadas por coma)</label>
          <input type="text" id="imagen" placeholder="https://res.cloudinary.com/tu_cuenta/...jpg" />
        </div>

        <div class="full upload-row" aria-hidden="false">
          <input type="file" id="fileUploader" accept="image/*" />
          <button type="button" class="ghost" id="btnUpload">Subir imagen</button>
          <p id="estadoUpload" class="muted">No has subido nada aún</p>
        </div>

        <div class="full" style="display:flex;align-items:center;gap:12px">
          <div style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="nueva_coleccion" style="width:18px;height:18px;" />
            <label for="nueva_coleccion">¿Pertenece a la nueva colección?</label>
          </div>
          <div style="margin-left:auto;width:220px;">
            <button type="submit" class="primary">Agregar producto</button>
          </div>
        </div>

        <div class="full">
          <div id="previewContainer">
            <p style="margin:6px 0;color:var(--muted)">Vista previa</p>
            <div id="previews" aria-live="polite"></div>
          </div>
        </div>
      </form>
    </section>

    <div style="height:14px"></div>

    <!-- FILTROS / BUSCADOR -->
    <section class="card" style="margin-top:10px">
      <div class="controls">
        <input id="buscador" placeholder="Buscar por nombre..." />
        <select id="filtroCategoria">
          <option value="">Todas las categorías</option>
          <option value="collar">Collares</option>
          <option value="aretes">Aretes</option>
          <option value="tobilleras">Tobilleras</option>
          <option value="pulseras">Pulseras</option>
          <option value="anillos">Anillos</option>
        </select>
        <select id="orden" style="width:160px">
          <option value="new">Orden: más recientes</option>
          <option value="price-asc">Precio: menor a mayor</option>
          <option value="price-desc">Precio: mayor a menor</option>
        </select>
        <div style="margin-left:auto;font-size:13px;color:var(--muted)"><span id="totalCount">0</span> productos</div>
      </div>

      <div id="productosGrid" class="grid" aria-live="polite"></div>
      <div class="pagination" id="paginacion" aria-label="Paginación"></div>
    </section>

    <div style="height:20px"></div>
    <div id="mensaje" style="text-align:center;color:green"></div>
  </div>

  <!-- MODAL EDITAR -->
  <div id="modalEditar" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card card" style="padding:18px;">
      <h3>Editar producto</h3>
      <label>Nombre</label>
      <input type="text" id="editNombre" />
      <label>Precio</label>
      <input type="number" id="editPrecio" />
      <label>Categoría</label>
      <select id="editCategoria">
        <option value="collar">Collares</option>
        <option value="aretes">Aretes</option>
        <option value="tobilleras">Tobilleras</option>
        <option value="pulseras">Pulseras</option>
        <option value="anillos">Anillos</option>
      </select>

      <label>Stock</label>
      <input type="number" id="editStock" />

      <label>Rutas de imagen</label>
      <input type="text" id="editImagen" />

      <label style="margin-top:10px;">
        <input type="checkbox" id="editNuevaColeccion" style="width:18px;height:18px; margin-right:6px;">
        ¿Pertenece a la nueva colección?
      </label>

      <div id="editPreviews" style="margin:10px 0"></div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
        <button id="btnGuardarEdit" class="primary">Guardar</button>
        <button id="btnCerrarModal" class="ghost">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay">
    <div id="loginBox" class="card">
      <h3 style="margin-top:0">Iniciar sesión</h3>
      <label>Usuario</label>
      <input id="loginUser" autocomplete="username" />
      <label>Contraseña</label>
      <input id="loginPass" type="password" autocomplete="current-password" />
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="loginBtn" class="primary">Entrar</button>
        <div style="flex:1"></div>
      </div>
      <p id="loginMsg" style="color:red;margin-top:8px"></p>
    </div>
  </div>

  <script>
    (function () {
      // CONFIG
      const API_URL = "/"; // admin served from backend's /public
      const CLOUD_NAME = "dt2qovj9c";
      const UPLOAD_PRESET = "ml_default";

      // STATE
      let productos = [];
      let currentPage = 1;
      const perPage = 6;
      const tokenKey = "avar_token";
      let productoEditando = null;

      // ELEMENTS
      const logoutBtn = document.getElementById("logoutBtn");
      const usuarioBadge = document.getElementById("usuarioBadge");
      const mensajeEl = document.getElementById("mensaje");
      const productosGrid = document.getElementById("productosGrid");
      const paginacionEl = document.getElementById("paginacion");
      const totalCountEl = document.getElementById("totalCount");

      // UTIL helpers
      function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"}[c])); }
      function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&#34;'); }
      function showMessage(text, color='green', timeout=3000){
        mensajeEl.style.color = color;
        mensajeEl.innerText = text;
        if(timeout) setTimeout(()=>{ if(mensajeEl.innerText===text) mensajeEl.innerText=''; }, timeout);
      }

      // AUTH
      logoutBtn.addEventListener("click", ()=>{
        sessionStorage.removeItem(tokenKey);
        location.reload();
      });

      async function checkAuth(){
        const token = sessionStorage.getItem(tokenKey);
        if (!token) return false;
        try{
          const res = await fetch('/api/auth-check', {headers: {'Authorization': 'Bearer '+token}});
          if (res.ok){
            const info = await res.json();
            usuarioBadge.innerText = info.user || 'admin';
            logoutBtn.style.display = 'inline-block';
            document.getElementById('loginOverlay').style.display = 'none';
            return true;
          }
        }catch(e){ console.warn('checkAuth error', e); }
        return false;
      }

      // LOGIN
      document.getElementById('loginBtn').addEventListener('click', async ()=>{
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        document.getElementById('loginMsg').innerText = '';
        try{
          const res = await fetch('/api/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({user:u, password:p})});
          if (!res.ok){
            const err = await res.json().catch(()=>({error:'Credenciales inválidas'}));
            document.getElementById('loginMsg').innerText = err.error || 'Credenciales inválidas';
            return;
          }
          const data = await res.json();
          sessionStorage.setItem(tokenKey, data.token);
          await initApp();
        }catch(e){ document.getElementById('loginMsg').innerText = 'Error de conexión'; console.error(e); }
      });

      // INIT
      async function initApp(){
        const ok = await checkAuth();
        if (!ok) return;
        await cargarProductos();
      }
      initApp();

      // CARGAR PRODUCTOS
      async function cargarProductos(){
        try{
          const res = await fetch('/api/productos');
          productos = await res.json();
          currentPage = 1;
          renderProductos();
        }catch(e){
          console.error('Error cargarProductos', e);
        }
      }

      // FILTRADO / ORDEN
      function getFiltered(){
        const q = (document.getElementById('buscador').value || '').toLowerCase();
        const cat = document.getElementById('filtroCategoria').value;
        let arr = (productos || []).filter(p => (p.nombre||'').toLowerCase().includes(q));
        if (cat) {
          arr = arr.filter(p => {
            // blind against null/undefined
            return String(p.categoria || '').toLowerCase() === String(cat).toLowerCase();
          });
        }
        const orden = document.getElementById('orden').value;
        if (orden === 'price-asc') arr.sort((a,b)=> (a.precio||0) - (b.precio||0));
        if (orden === 'price-desc') arr.sort((a,b)=> (b.precio||0) - (a.precio||0));
        if (orden === 'new') arr.sort((a,b)=> (b.id||0) - (a.id||0));
        return arr;
      }

      // RENDER PRODUCTOS (sin HTML inline handlers)
      function renderProductos(){
        const arr = getFiltered();
        totalCountEl.innerText = arr.length;
        const start = (currentPage-1) * perPage;
        const pageItems = arr.slice(start, start + perPage);

        productosGrid.innerHTML = '';
        pageItems.forEach(p => {
          const card = document.createElement('div');
          card.className = 'producto-card';

          const title = document.createElement('h4');
          title.innerHTML = `${escapeHtml(p.nombre || '')} ${p.nueva_coleccion ? '<span style="color:var(--gold)">✨</span>' : ''}`;
          card.appendChild(title);

          const row = document.createElement('div');
          row.style = 'display:flex;gap:10px;align-items:center';

          const img = document.createElement('img');
          const firstUrl = (p.imagen || '').split(',')[0].trim();
          img.src = firstUrl || '';
          img.alt = p.nombre || '';
          img.style = 'width:80px;height:80px;object-fit:cover;border-radius:8px;';
          img.onerror = function(){ this.style.display = 'none'; };
          row.appendChild(img);

          const info = document.createElement('div');
          info.style = 'flex:1';
          const priceDiv = document.createElement('div');
          priceDiv.textContent = '$' + Number(p.precio || 0).toLocaleString('es-ES');
          const catDiv = document.createElement('div');
          catDiv.style = 'color:var(--muted)';
          catDiv.textContent = p.categoria || '';
          info.appendChild(priceDiv);
          info.appendChild(catDiv);
          row.appendChild(info);
          card.appendChild(row);

          const small = document.createElement('small');
          small.innerHTML = escapeHtml(p.imagen || '');
          card.appendChild(small);

          const actions = document.createElement('div');
          actions.className = 'producto-actions';

          const btnEdit = document.createElement('button');
          btnEdit.className = 'ghost';
          btnEdit.textContent = 'Editar';
          btnEdit.addEventListener('click', ()=> abrirModalSegura(p));
          actions.appendChild(btnEdit);

          const btnDelete = document.createElement('button');
          btnDelete.className = 'ghost';
          btnDelete.style = 'background:#ffecec;border:1px solid #f5c2c2';
          btnDelete.textContent = 'Eliminar';
          btnDelete.addEventListener('click', ()=> eliminarProducto(p.id));
          actions.appendChild(btnDelete);

          card.appendChild(actions);

          productosGrid.appendChild(card);
        });

        renderPagination(Math.ceil(arr.length / perPage));
      }

      // PAGINACION
      function renderPagination(pages){
        paginacionEl.innerHTML = '';
        if (!pages || pages <= 1) return;
        for(let i = 1; i <= pages; i++){
          const btn = document.createElement('button');
          btn.innerText = i;
          if (i === currentPage) btn.style.fontWeight = '700';
          btn.addEventListener('click', ()=> { currentPage = i; renderProductos(); });
          paginacionEl.appendChild(btn);
        }
      }

      // EVENTOS FILTROS
      document.getElementById('buscador').addEventListener('input', ()=> { currentPage = 1; renderProductos(); });
      document.getElementById('filtroCategoria').addEventListener('change', ()=> { currentPage = 1; renderProductos(); });
      document.getElementById('orden').addEventListener('change', ()=> { renderProductos(); });

      // ELIMINAR PRODUCTO
      async function eliminarProducto(id){
        if (!confirm('¿Eliminar producto?')) return;
        const token = sessionStorage.getItem(tokenKey);
        try{
          const res = await fetch(`/api/productos/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer '+token }});
          if (res.status === 204){
            showMessage('✅ Producto eliminado', 'green', 2500);
            await cargarProductos();
          } else {
            const d = await res.json().catch(()=>({error:'Error'}));
            showMessage('❌ ' + (d.error || 'No se pudo eliminar'), 'red', 4000);
          }
        }catch(e){
          console.error('eliminarProducto error', e);
          showMessage('❌ Error de conexión', 'red', 4000);
        }
      }

      // AGREGAR PRODUCTO
      document.getElementById('formProducto').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const token = sessionStorage.getItem(tokenKey);
        const producto = {
          nombre: (document.getElementById('nombre').value || '').trim(),
          precio: Number(document.getElementById('precio').value || 0),
          categoria: document.getElementById('categoria').value || '',
          stock: Number(document.getElementById('stock').value || 0),
          imagen: (document.getElementById('imagen').value || '').trim(),
          nueva_coleccion: !!document.getElementById('nueva_coleccion').checked
        };

        try{
          const res = await fetch('/api/productos', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer '+token }, body: JSON.stringify(producto) });
          if (res.ok){
            const data = await res.json().catch(()=>null);
            showMessage('✔ Producto agregado', 'green', 2500);
            // clean form properly (reset and previews)
            resetFormProducto();
            await cargarProductos();
          } else {
            const d = await res.json().catch(()=>({error:'Error al agregar'}));
            showMessage('❌ ' + (d.error || 'Error al agregar'), 'red', 4000);
          }
        }catch(err){
          console.error('agregarProducto error', err);
          showMessage('❌ Error de conexión', 'red', 4000);
        }
      });

      function resetFormProducto(){
        const form = document.getElementById('formProducto');
        form.reset();
        // ensure checkbox is unchecked
        document.getElementById('nueva_coleccion').checked = false;
        // clear previews
        document.getElementById('previews').innerHTML = '';
        document.getElementById('imagen').value = '';
        document.getElementById('fileUploader').value = '';
        document.getElementById('estadoUpload').innerText = 'No has subido nada aún';
      }

      // Cloudinary upload (one by one)
      document.getElementById('btnUpload').addEventListener('click', subirImagenCloudinary);

      async function subirImagenCloudinary(){
        const fileInput = document.getElementById('fileUploader');
        const estado = document.getElementById('estadoUpload');
        const campoImagen = document.getElementById('imagen');
        if (!fileInput.files.length){ estado.innerText = 'Selecciona una imagen'; estado.style.color = 'red'; return; }
        const file = fileInput.files[0];
        estado.innerText = 'Subiendo...';
        estado.style.color = '#b6922e';
        const fd = new FormData();
        fd.append('file', file);
        fd.append('upload_preset', UPLOAD_PRESET);
        fd.append('folder', 'productos');

        try{
          const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: fd });
          const data = await res.json();
          if (data && data.secure_url){
            estado.innerText = 'Subida ✔️';
            estado.style.color = 'green';
            campoImagen.value = campoImagen.value.trim() ? campoImagen.value + ', ' + data.secure_url : data.secure_url;
            campoImagen.dispatchEvent(new Event('input'));
            fileInput.value = '';
          } else {
            estado.innerText = 'Error al subir';
            estado.style.color = 'red';
            console.error('Cloudinary error', data);
          }
        }catch(e){
          console.error('subirImagenCloudinary error', e);
          estado.innerText = 'Error de red';
          estado.style.color = 'red';
        }
      }

      // PREVIEWS y remover URL individual
      document.getElementById('imagen').addEventListener('input', ()=> renderPreviewsFromInput('imagen','previews'));
      function renderPreviewsFromInput(inputId, containerId){
        const cont = document.getElementById(containerId);
        cont.innerHTML = '';
        const lista = (document.getElementById(inputId).value || '').split(',').map(s=>s.trim()).filter(Boolean);
        lista.forEach((url, idx) => {
          const t = document.createElement('div'); t.className = 'thumb';
          const img = document.createElement('img'); img.src = url; img.alt = '';
          const btn = document.createElement('button'); btn.innerText = '×'; btn.title = 'Eliminar imagen';
          btn.addEventListener('click', ()=> { removeImageFromInput(inputId, idx); });
          t.appendChild(img); t.appendChild(btn); cont.appendChild(t);
        });
      }

      // EDIT PREVIEWS
      document.getElementById('editImagen').addEventListener('input', ()=> renderEditPreviews());
      function renderEditPreviews(){
        renderPreviewsFromInput('editImagen','editPreviews');
      }

      function removeImageFromInput(inputId, index){
        const el = document.getElementById(inputId);
        const arr = (el.value || '').split(',').map(s=>s.trim()).filter(Boolean);
        arr.splice(index, 1);
        el.value = arr.join(', ');
        el.dispatchEvent(new Event('input'));
      }

      // ABRIR MODAL (seguro) pasando objeto producto
      function abrirModalSegura(producto){
        productoEditando = producto.id;
        document.getElementById('editNombre').value = producto.nombre || '';
        document.getElementById('editPrecio').value = producto.precio || 0;
        document.getElementById('editCategoria').value = producto.categoria || '';
        document.getElementById('editStock').value = producto.stock || 0;
        document.getElementById('editImagen').value = producto.imagen || '';
        document.getElementById('editNuevaColeccion').checked = !!producto.nueva_coleccion;
        renderEditPreviews();
        openModal();
      }

      function openModal(){
        const modal = document.getElementById('modalEditar');
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden','false');
      }
      function closeModal(){
        const modal = document.getElementById('modalEditar');
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden','true');
      }
      document.getElementById('btnCerrarModal').addEventListener('click', closeModal);

      // GUARDAR EDICION
      document.getElementById('btnGuardarEdit').addEventListener('click', async ()=>{
        const token = sessionStorage.getItem(tokenKey);
        const producto = {
          nombre: (document.getElementById('editNombre').value || '').trim(),
          precio: Number(document.getElementById('editPrecio').value || 0),
          categoria: document.getElementById('editCategoria').value || '',
          stock: Number(document.getElementById('editStock').value || 0),
          imagen: (document.getElementById('editImagen').value || '').trim(),
          nueva_coleccion: !!document.getElementById('editNuevaColeccion').checked
        };
        try{
          const res = await fetch(`/api/productos/${productoEditando}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer '+token }, body: JSON.stringify(producto) });
          if (res.ok){
            showMessage('✅ Producto actualizado', 'green', 2500);
            closeModal();
            await cargarProductos();
          } else {
            const d = await res.json().catch(()=>({error:'Error al actualizar'}));
            showMessage('❌ ' + (d.error || 'Error al actualizar'), 'red', 4000);
          }
        }catch(e){
          console.error('guardarEdicion error', e);
          showMessage('❌ Error de conexión', 'red', 4000);
        }
      });

      // HELPERS: abrir/close modal clicking outside
      document.getElementById('modalEditar').addEventListener('click', (e)=>{
        if (e.target === document.getElementById('modalEditar')) closeModal();
      });

      // Ensure editPreviews reacts to manual typing
      document.getElementById('editImagen').addEventListener('input', renderEditPreviews);

      // Keep session only while tab open (sessionStorage already does that)
      // Extra: when user closes tab, sessionStorage cleared automatically.
      // Optionally, force logout on beforeunload (commented - not necessary)
      // window.addEventListener('beforeunload', ()=> sessionStorage.removeItem(tokenKey));

      // Inicial focus accessibility
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape') {
          // close modal if open
          if (document.getElementById('modalEditar').style.display === 'flex') closeModal();
        }
      });

      // Expose one quick function for debugging in console (optional)
      window.__admin_debug_reload = cargarProductos;

    })();
  </script>
</body>
</html>